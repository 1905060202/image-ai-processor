# 系统升级总结 - 后台管理与积分系统

## 🎉 升级完成

本次升级为系统添加了完整的后台管理系统、积分系统和权限细化功能。

---

## ✨ 新增功能

### 1. 积分系统
- ✅ 用户积分管理
- ✅ 积分扣除机制
- ✅ 积分充值功能
- ✅ 使用记录追踪

### 2. 使用限制
- ✅ **文生图**：普通用户免费5次，超过后需要积分（10积分/次）
- ✅ **图生图**：需要消耗积分（5积分/次）
- ✅ **管理员**：不受限制，可免费使用所有功能

### 3. 后台管理系统
- ✅ 用户管理：查看、搜索用户列表
- ✅ 权限管理：修改用户角色（user/admin）
- ✅ 积分管理：为用户充值积分
- ✅ 充值记录：查看所有充值历史
- ✅ 使用统计：查看系统使用情况

### 4. 前端增强
- ✅ 积分显示：实时显示用户积分和免费次数
- ✅ 权限提示：积分不足时友好提示
- ✅ 后台入口：管理员可快速进入后台

---

## 📊 数据库变更

### 新增字段

**Users 表**：
- `credits` (INTEGER, 默认0) - 用户积分
- `freeTextToImageCount` (INTEGER, 默认0) - 免费文生图使用次数

### 新增表

**UsageRecord 表**（使用记录）：
- `id` - 主键
- `userId` - 用户ID（外键）
- `type` - 使用类型（text-to-image/image-to-image）
- `cost` - 消耗的积分
- `isFree` - 是否免费使用
- `imageId` - 关联的图片ID
- `createdAt` - 创建时间

**RechargeRecord 表**（充值记录）：
- `id` - 主键
- `userId` - 用户ID（外键）
- `amount` - 充值数量
- `operatorId` - 操作员ID（管理员充值时）
- `reason` - 充值原因/备注
- `createdAt` - 创建时间

---

## 🔧 新增文件

### 后端文件

1. **`lib/creditManager.js`** - 积分管理系统
   - `checkTextToImagePermission()` - 检查文生图权限
   - `checkImageToImagePermission()` - 检查图生图权限
   - `deductCredits()` - 扣除积分
   - `rechargeCredits()` - 充值积分
   - `getUserCredits()` - 获取用户积分信息
   - `getUserUsageRecords()` - 获取使用记录

2. **`routes/admin.js`** - 管理员路由
   - `GET /api/admin/users` - 获取用户列表
   - `GET /api/admin/users/:id` - 获取用户详情
   - `PATCH /api/admin/users/:id/role` - 修改用户角色
   - `POST /api/admin/users/:id/recharge` - 为用户充值
   - `GET /api/admin/recharges` - 获取充值记录
   - `GET /api/admin/usage-stats` - 获取使用统计

3. **`routes/credits.js`** - 积分查询路由
   - `GET /api/credits/info` - 获取当前用户积分信息
   - `GET /api/credits/usage` - 获取当前用户使用记录

### 前端文件

1. **`public/admin.html`** - 后台管理界面
   - 用户管理标签页
   - 充值记录标签页
   - 使用统计标签页

---

## 🔄 修改的文件

### 后端

1. **`lib/database.js`**
   - 添加 `credits` 和 `freeTextToImageCount` 字段到 User 模型
   - 新增 `UsageRecord` 和 `RechargeRecord` 模型
   - 建立关联关系

2. **`routes/imageProcessor.js`**
   - 文生图路由添加权限检查
   - 图生图路由添加权限检查
   - 生成成功后扣除积分并记录

3. **`routes/auth.js`**
   - `/api/auth/me` 接口返回积分信息

4. **`server.js`**
   - 添加 `/admin` 路由
   - 注册管理员路由和积分路由

### 前端

1. **`public/index.html`**
   - 添加积分显示
   - 添加免费次数显示
   - 添加后台管理按钮（仅管理员可见）

2. **`public/js/app.js`**
   - 添加积分信息加载
   - 添加积分不足提示
   - 生成成功后更新积分显示

---

## 📝 使用说明

### 普通用户

1. **免费使用**：
   - 文生图功能：前5次免费
   - 超过5次后需要积分（10积分/次）

2. **积分使用**：
   - 图生图：5积分/次
   - 文生图（超过免费次数）：10积分/次

3. **积分获取**：
   - 联系管理员充值

### 管理员

1. **访问后台**：
   - 登录后点击右上角"后台管理"按钮
   - 或直接访问 `/admin`

2. **用户管理**：
   - 查看所有用户列表
   - 搜索用户
   - 修改用户角色（user/admin）
   - 为用户充值积分

3. **查看统计**：
   - 查看充值记录
   - 查看使用统计
   - 查看各类型使用情况

4. **权限**：
   - 管理员不受使用限制
   - 可以免费使用所有功能

---

## 🔐 权限说明

### 角色权限

**普通用户 (user)**：
- ✅ 文生图：免费5次，超过需要积分
- ✅ 图生图：需要积分
- ✅ 查看自己的图片
- ✅ 查看自己的积分和使用记录

**管理员 (admin)**：
- ✅ 所有功能免费使用
- ✅ 查看所有用户的图片
- ✅ 访问后台管理系统
- ✅ 管理用户和权限
- ✅ 为用户充值积分
- ✅ 查看系统统计

---

## 💡 配置说明

### 积分配置（`lib/creditManager.js`）

```javascript
const FREE_TEXT_TO_IMAGE_LIMIT = 5;  // 免费文生图次数
const TEXT_TO_IMAGE_COST = 10;      // 文生图消耗积分
const IMAGE_TO_IMAGE_COST = 5;      // 图生图消耗积分
```

可以根据需要修改这些常量。

---

## 🚀 部署说明

1. **数据库迁移**：
   - 系统启动时会自动创建新表和字段
   - 使用 `sequelize.sync({ alter: true })` 自动同步

2. **环境变量**：
   - 确保 `JWT_SECRET` 已设置
   - 确保数据库连接正常

3. **首次使用**：
   - 注册第一个账号
   - 在数据库中将其 `role` 设置为 `admin`
   - 或通过后台管理界面修改角色

---

## 📈 未来扩展建议

1. **支付系统**：集成在线支付，用户自助充值
2. **积分套餐**：设置不同的积分套餐和价格
3. **使用限制细化**：不同用户等级有不同的限制
4. **积分奖励**：完成任务或活动获得积分
5. **使用报表**：更详细的使用分析和报表

---

## 🐛 已知问题

无

---

## ✅ 测试清单

- [x] 用户注册和登录
- [x] 文生图免费次数限制
- [x] 积分扣除机制
- [x] 管理员后台访问
- [x] 用户管理功能
- [x] 积分充值功能
- [x] 使用记录追踪
- [x] 权限控制

---

**升级完成！** 🎉

